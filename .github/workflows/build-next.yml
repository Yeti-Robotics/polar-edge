name: Build Next.js
on: workflow_call
jobs:
    build:
        runs-on: ubuntu-latest
        environment: ci
        env:
            POSTGRES_URL: ${{ vars.POSTGRES_URL }}
            NEXT_PUBLIC_SUPABASE_URL: ${{ vars.NEXT_PUBLIC_SUPABASE_URL }}
            NEXT_PUBLIC_SUPABASE_REDIRECT_URL: ${{ vars.NEXT_PUBLIC_SUPABASE_REDIRECT_URL }}
        steps:
            - name: Checkout Code
              uses: actions/checkout@v4

            - name: Install Node/node_modules
              uses: ./.github/actions/site-setup

            - name: Create .env.production
              run: | # Secrets needed to create app
                  echo "SUPABASE_AUTH_DISCORD_CLIENT_ID=${{secrets.SUPABASE_AUTH_DISCORD_CLIENT_ID}}" >> .env.production
                  echo "SUPABASE_AUTH_DISCORD_SECRET=${{secrets.SUPABASE_AUTH_DISCORD_SECRET}}" >> .env.production
                  echo "SUPABASE_SERVICE_KEY=${{secrets.SUPABASE_SERVICE_KEY}}" >> .env.production
                  echo "NEXT_PUBLIC_SUPABASE_ANON_KEY=${{secrets.NEXT_PUBLIC_SUPABASE_ANON_KEY}}" >> .env.production
                  echo "JWT_SECRET=${{secrets.JWT_SECRET}}" >> .env.production
              shell: bash

            - name: Run Next.js Build
              run: npm run build
              shell: bash
